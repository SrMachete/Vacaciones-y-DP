const asociados = [{"login": "bricafon", "turno": "DB", "procesos": ["Pick", "Pit", "Pack", "Rebin", "Dock"], "color": "black"}, {"login": "anorvpma", "turno": "DX", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "seguralm", "turno": "DB", "procesos": ["Pick", "Dock", "Trans"], "color": "black"}, {"login": "ivzpauli", "turno": "DX", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "isavargy", "turno": "D5", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "pinedrol", "turno": "DX", "procesos": ["Dock", "Pick"], "color": "black"}, {"login": "gagibran", "turno": "DB", "procesos": ["Pick", "Pack", "Rebin", "Dock", "Capitan", "Trans", "Cargas", "TDR"], "color": "black"}, {"login": "aedsonsa", "turno": "DB", "procesos": ["Pick", "Dock", "Capitan", "TDR", "Delibery"], "color": "black"}, {"login": "quirozzg", "turno": "DX", "procesos": ["Pick", "Pack", "Dock"], "color": "black"}, {"login": "doranbet", "turno": "DB", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "gacalebb", "turno": "DH", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "gonletio", "turno": "DB", "procesos": ["Dock", "PCNS"], "color": "black"}, {"login": "enriqqme", "turno": "D5", "procesos": ["Pick", "Dock", "Delibery"], "color": "black"}, {"login": "yamezal", "turno": "DB", "procesos": ["Pick", "Dock", "PCNS"], "color": "black"}, {"login": "esaucvic", "turno": "DB", "procesos": ["Pack", "Rebin", "Dock"], "color": "black"}, {"login": "eherrcla", "turno": "DB", "procesos": ["Pick", "Pack", "Rebin", "Dock", "PCNS", "Delibery"], "color": "black"}, {"login": "oyuortiz", "turno": "DB", "procesos": ["Pick", "Pack", "Rebin", "Dock", "PCNS"], "color": "black"}, {"login": "vazemari", "turno": "DB", "procesos": ["Pick", "Dock", "Delibery", "PCNS"], "color": "black"}, {"login": "lucbgali", "turno": "D5", "procesos": ["Pick", "Dock", "Delibery"], "color": "black"}, {"login": "mzmln", "turno": "DB", "procesos": ["Pick", "Pack", "Dock", "Trans", "Pit", "TDR"], "color": "black"}, {"login": "melinusa", "turno": "DB", "procesos": ["Pick", "Pack", "Dock", "Cargas", "Delibery", "PCNS", "TDR", "Auditor"], "color": "black"}, {"login": "marmissa", "turno": "DB", "procesos": ["Pick", "Pit", "Dock", "Capitan", "Trans", "TDR"], "color": "black"}, {"login": "garctarm", "turno": "DB", "procesos": ["Pick", "Pack", "Rebin", "Dock", "Capitan", "Cargas", "PCNS", "TDR"], "color": "black"}, {"login": "servjenz", "turno": "DX", "procesos": ["Pick", "Dock", "PCNS", "TDR"], "color": "black"}, {"login": "jonramom", "turno": "D5", "procesos": ["Pick", "Pack", "Rebin", "Dock"], "color": "black"}, {"login": "dvilpedr", "turno": "DI", "procesos": ["Pick", "Pit", "Trans", "Dock", "TDR"], "color": "black"}, {"login": "ncacarmo", "turno": "DJ", "procesos": ["Pick", "Rebin", "Dock", "Capitan"], "color": "black"}, {"login": "urielagu", "turno": "DI", "procesos": ["Pick", "Dock", "Capitan"], "color": "black"}, {"login": "elireyer", "turno": "DI", "procesos": ["Pick", "Pack", "Rebin", "Dock"], "color": "black"}, {"login": "matafepe", "turno": "DJ", "procesos": ["Pack", "Rebin", "Dock", "PCNS"], "color": "black"}, {"login": "nerkmar", "turno": "DJ", "procesos": ["Pick", "Pack", "Rebin", "Dock"], "color": "black"}, {"login": "edweulog", "turno": "DJ", "procesos": ["Pick", "Pack", "Dock", "Capitan", "PCNS"], "color": "black"}, {"login": "ezpitika", "turno": "DI", "procesos": ["Pick", "Dock", "Capitan", "PCNS"], "color": "black"}, {"login": "vmariocl", "turno": "DC", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "geovansn", "turno": "DC", "procesos": ["Pick", "Rebin", "Dock"], "color": "black"}, {"login": "rruperez", "turno": "DX", "procesos": ["Pick", "Pit", "Pack", "Rebin", "Dock", "Trans", "TDR"], "color": "black"}, {"login": "xbeamart", "turno": "D5", "procesos": ["Pack", "Rebin", "Dock"], "color": "black"}, {"login": "briaarag", "turno": "DB", "procesos": ["Dock", "Capitan", "Cargas", "TDR"], "color": "black"}, {"login": "doryamil", "turno": "DB", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "ycralan", "turno": "DB", "procesos": ["Pick", "Pit", "Rebin", "Dock", "Trans", "TDR"], "color": "black"}, {"login": "emimonro", "turno": "DB", "procesos": ["Pick", "Pack", "Rebin", "Dock", "TDR", "Capitan", "Cargas"], "color": "black"}, {"login": "xadvazq", "turno": "DB", "procesos": ["Pick", "Dock"], "color": "black"}, {"login": "wcovivia", "turno": "DB", "procesos": ["Pick", "Pack", "Dock", "PCNS"], "color": "black"}, {"login": "beninmar", "turno": "DR", "procesos": ["Pick", "Pack", "Rebin", "Sort", "PCNS"], "color": "black"}, {"login": "lopdemia", "turno": "DR", "procesos": ["Pick", "Rebin", "Sort", "Dock", "Trans", "Pit"], "color": "black"}, {"login": "cholulaj", "turno": "DC", "procesos": ["Pick", "Dock"], "color": "black"}];
const turnoColors = {"DC": "brown", "DR": "pink", "DB": "gold", "D5": "cyan", "DX": "orchid", "DI": "peru", "DJ": "salmon", "DH": "sienna"};
const procColors = {"Pick": "blue", "Pit": "green", "Pack": "red", "Rebin": "orange", "Dock": "purple", "Trans": "teal", "Cargas": "magenta", "TDR": "lime", "Delibery": "olive", "PCNS": "navy", "Auditor": "maroon", "Sort": "silver"};
let asignaciones = JSON.parse(localStorage.getItem("asignaciones_hl3")) || {};
let currentDate = new Date();

const calendarEl = document.getElementById("calendar");
const monthYearEl = document.getElementById("monthYear");
const popup = document.getElementById("popup");
const popupDate = document.getElementById("popupDate");
const assignedList = document.getElementById("assignedList");
const selectAssociate = document.getElementById("selectAssociate");
const addBtn = document.getElementById("addAssociateBtn");
const closeBtn = document.getElementById("closeBtn");

function renderCalendar() {
  calendarEl.innerHTML = "";
  const y = currentDate.getFullYear(), m = currentDate.getMonth();
  monthYearEl.textContent = currentDate.toLocaleString("es-MX", { month:'long', year:'numeric' });
  const firstDay = new Date(y,m,1).getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();
  for(let i=0;i<firstDay;i++) calendarEl.appendChild(document.createElement("div"));
  for(let d=1; d<=daysInMonth; d++) {
    const dateKey = `${y}-${m+1}-${d}`;
    const cell = document.createElement("div");
    cell.classList.add("day-cell");
    cell.innerHTML = `<div class="day-number">${d}</div>`;
    const assigns = asignaciones[dateKey] || [];
    if(assigns.length > 0) {
      cell.classList.add("assigned");
    }
    const dockCount = assigns.filter(a => a.procesos.includes("Dock")).length;
    if(dockCount >= 5) {
      cell.classList.remove("assigned");
      cell.classList.add("alert");
    }
    cell.onclick = () => showPopup(dateKey);
    calendarEl.appendChild(cell);
  }
}

function showPopup(dateKey) {
  popup.classList.remove("hidden");
  popupDate.textContent = "Asignaciones " + dateKey;
  assignedList.innerHTML = "";
  (asignaciones[dateKey] || []).forEach(a => {
    const li = document.createElement("li");
    const turnLabel = document.createElement("span");
    turnLabel.textContent = a.turno;
    turnLabel.className = "turno-label";
    turnLabel.style.background = turnoColors[a.turno] || 'gray';
    const procContainer = document.createElement("div");
    a.procesos.forEach(p => {
      const pb = document.createElement("span");
      pb.textContent = p;
      pb.className = "proc-badge";
      pb.style.background = procColors[p] || 'gray';
      procContainer.appendChild(pb);
    });
    const textSpan = document.createElement("span");
    textSpan.textContent = a.login;
    textSpan.style.marginLeft = "8px";
    textSpan.style.marginRight = "8px";
    textSpan.style.flexGrow = "1";
    textSpan.style.color = a.color;
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Quitar";
    removeBtn.classList.add("removeBtn");
    removeBtn.onclick = () => removeAssociate(dateKey, a.login);
    li.appendChild(turnLabel);
    li.appendChild(textSpan);
    li.appendChild(procContainer);
    li.appendChild(removeBtn);
    assignedList.appendChild(li);
  });
  selectAssociate.innerHTML = "";
  asociados.filter(a => !(asignaciones[dateKey]||[]).some(x => x.login === a.login))
    .forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.login;
      opt.textContent = a.login;
      selectAssociate.appendChild(opt);
    });
  addBtn.onclick = () => {
    const login = selectAssociate.value;
    if (!login) return;
    const a = asociados.find(x => x.login === login);
    asignaciones[dateKey] = asignaciones[dateKey] || [];
    if (!asignaciones[dateKey].some(x => x.login === login)) {
      asignaciones[dateKey].push(a);
      localStorage.setItem("asignaciones_hl3", JSON.stringify(asignaciones));
    }
    renderCalendar();
    showPopup(dateKey);
  };
}

function removeAssociate(dateKey, login) {
  asignaciones[dateKey] = (asignaciones[dateKey] || []).filter(a => a.login !== login);
  if(asignaciones[dateKey].length === 0) delete asignaciones[dateKey];
  localStorage.setItem("asignaciones_hl3", JSON.stringify(asignaciones));
  renderCalendar();
  showPopup(dateKey);
}

closeBtn.onclick = () => popup.classList.add("hidden");
document.getElementById("prevMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
document.getElementById("nextMonth").onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
window.onload = renderCalendar;
